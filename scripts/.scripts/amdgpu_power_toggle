#!/bin/bash

# Usage: sudo ./amdgpu_power_toggle on|off

DRIVER="amdgpu"
CARD_PATH="/sys/class/drm/card0/device"
PCI_ID=$(basename $(readlink "$CARD_PATH"))

if [[ $EUID -ne 0 ]]; then
    echo "Please run as root (use sudo)."
    exit 1
fi

if [[ $# -ne 1 ]]; then
    echo "Usage: $0 on|off"
    exit 1
fi

case "$1" in
  off)
    echo "üõë Stopping and disabling GDM..."
    systemctl stop gdm.service
    systemctl disable gdm.service

    echo "üîå Unbinding and unloading GPU..."
    echo "$PCI_ID" > /sys/bus/pci/drivers/$DRIVER/unbind 2>/dev/null
    echo 0 > /sys/class/vtconsole/vtcon0/bind 2>/dev/null || true
    echo 0 > /sys/class/vtconsole/vtcon1/bind 2>/dev/null || true
    modprobe -r amdgpu ttm drm_kms_helper drm i2c_algo_bit
    ;;

  on)
    echo "‚ö° Loading and rebinding GPU..."
    modprobe $DRIVER
    echo "$PCI_ID" > /sys/bus/pci/drivers/$DRIVER/bind

    echo "‚ñ∂Ô∏è Enabling and starting GDM..."
    systemctl enable gdm.service
    systemctl start gdm.service
    ;;

  *)
    echo "Invalid option: $1"
    echo "Usage: $0 on|off"
    exit 1
    ;;
esac



