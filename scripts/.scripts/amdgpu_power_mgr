#!/bin/bash

# Usage: sudo ./amdgpu_power_mgr on|off|low|auto|status

DRIVER="amdgpu"
CARD_PATH="/sys/class/drm/card0/device"
PCI_ID=$(basename "$(readlink "$CARD_PATH")")
POWER_FILE="$CARD_PATH/power_dpm_force_performance_level"
PCI_CONTROL="/sys/bus/pci/devices/$PCI_ID/power/control"

if [[ $EUID -ne 0 ]]; then
    echo "‚ùå Please run this script as root (sudo)."
    exit 1
fi

if [[ $# -ne 1 ]]; then
    echo "Usage: $0 on|off|low|auto|status"
    exit 1
fi

case "$1" in
  off)
    echo "üîå Unbinding and unloading GPU..."
    echo "$PCI_ID" > /sys/bus/pci/drivers/$DRIVER/unbind 2>/dev/null
    echo 0 > /sys/class/vtconsole/vtcon0/bind 2>/dev/null || true
    echo 0 > /sys/class/vtconsole/vtcon1/bind 2>/dev/null || true
    modprobe -r amdgpu ttm drm_kms_helper drm i2c_algo_bit
    ;;

  on)
    echo "‚ö° Loading and rebinding GPU..."
    modprobe $DRIVER
    echo "$PCI_ID" > /sys/bus/pci/drivers/$DRIVER/bind
    ;;

  low)
    if [[ -f "$POWER_FILE" ]]; then
      echo "üåô Setting GPU to LOW power..."
      echo low > "$POWER_FILE"
    else
      echo "‚ö†Ô∏è Power state control not available."
    fi
    ;;

  auto)
    if [[ -f "$POWER_FILE" ]]; then
      echo "üöÄ Setting GPU to AUTO performance..."
      echo auto > "$POWER_FILE"
    else
      echo "‚ö†Ô∏è Power state control not available."
    fi
    ;;

  status)
    echo "üîç AMDGPU Status:"
    echo -n "  ‚û§ Driver loaded: "
    lsmod | grep -q "$DRIVER" && echo "yes" || echo "no"

    echo -n "  ‚û§ GPU bound to driver: "
    if [[ -L "/sys/bus/pci/drivers/$DRIVER/$PCI_ID" ]]; then
      echo "yes"
    else
      echo "no"
    fi

    # Show current power performance level if possible
    if [[ -f "$POWER_FILE" ]]; then
      POWER_LEVEL=$(cat "$POWER_FILE")
      echo "  ‚û§ Current power performance level: $POWER_LEVEL"
    elif [[ -f "$PCI_CONTROL" ]]; then
      PCI_STATE=$(cat "$PCI_CONTROL")
      echo "  ‚û§ Current PCI power control state: $PCI_STATE"
    else
      echo "  ‚û§ Current power performance level: unavailable"
    fi
    ;;

  *)
    echo "‚ùå Invalid option: $1"
    echo "Usage: $0 on|off|low|auto|status"
    exit 1
    ;;
esac

