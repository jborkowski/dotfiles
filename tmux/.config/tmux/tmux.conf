# ============================================
# TMUX Config - Universal (Claude Code Orchestration)
# ============================================

# Prefix to Ctrl-a (like in screen)
set-option -g prefix C-a
unbind-key C-b
bind-key C-a send-prefix

# Vim-style pane navigation (used by vim-tmux-navigator)
is_vim="ps -o state= -o comm= -t '#{pane_tty}' \
    | grep -iqE '^[^TXZ]* +(n?vim|vimx?)$'"
bind -n C-h if-shell "$is_vim" "send-keys C-h" "select-pane -L"
bind -n C-j if-shell "$is_vim" "send-keys C-j" "select-pane -D"
bind -n C-k if-shell "$is_vim" "send-keys C-k" "select-pane -U"
bind -n C-l if-shell "$is_vim" "send-keys C-l" "select-pane -R"

# Split panes (vim-style)
bind | split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# Enable mouse support
set -g mouse on

# Vi mode for copy mode
setw -g mode-keys vi

# Vi copy mode bindings
bind-key -T copy-mode-vi v send-keys -X begin-selection
bind-key -T copy-mode-vi C-v send-keys -X rectangle-toggle
bind-key -T copy-mode-vi y send-keys -X copy-selection-and-cancel

# Terminal settings
set -g default-terminal "xterm-256color"
set -g terminal-overrides 'xterm*:Tc'

# Clipboard: use OSC52 for copying (works in SSH, containers, etc.)
set -g set-clipboard on

# Allow OSC escape sequences to pass through (for NeoVim OSC52 clipboard)
set -g allow-passthrough all

# ============================================
# Claude Code Spawning (Universal)
# ============================================

# Ctrl-a c - Spawn Claude Code in current directory (new window)
bind c new-window -c "#{pane_current_path}" -n "claude" "claude; exec $SHELL"

# Ctrl-a P - Spawn Claude in new pane (vertical split)
bind P split-window -v -c "#{pane_current_path}" "claude; exec $SHELL"

# NOTE: Ctrl-a C (directory picker) is defined in host-specific config

# ============================================
# Session Management
# ============================================

# New window inherits current path
bind n new-window -c "#{pane_current_path}"

# Reload config
bind R source-file ~/.config/tmux/tmux.conf \; display-message "Config reloaded!"

# ============================================
# Status Bar
# ============================================

set -g status-style "bg=default,fg=white"
set -g status-left "#[fg=cyan,bold][#H] #[fg=yellow]#S #[default]"
set -g status-left-length 30
set -g status-right "#[fg=green]%H:%M#[default]"

# Window status
set -g window-status-format "#[fg=gray]#I:#W"
set -g window-status-current-format "#[fg=cyan,bold]#I:#W"

# ============================================
# Plugins
# ============================================

set -g @plugin 'tmux-plugins/tpm'
set -g @plugin 'tmux-plugins/tmux-resurrect'
set -g @plugin 'tmux-plugins/tmux-continuum'
set -g @plugin 'tmux-plugins/tmux-yank'

# Yank settings (for scroll/copy mode)
set -g @yank_selection_mouse 'clipboard'
set -g @yank_action 'copy-pipe-and-cancel'

# Resurrect settings
set -g @resurrect-capture-pane-contents 'on'
set -g @continuum-restore 'on'
set -g @continuum-save-interval '15'

# Initialize TPM (keep at bottom)
run-shell ~/.tmux/plugins/tpm/tpm

# ============================================
# Host-specific config
# ============================================

# Source host-specific config (silently fails if not found)
run-shell 'tmux source-file ~/.config/tmux/hosts/$(hostname -s).conf 2>/dev/null || true'

# Optional local override (not in git)
if-shell '[ -f ~/.config/tmux/local.conf ]' 'source-file ~/.config/tmux/local.conf'
